{% sw_extends '@Storefront/storefront/base.html.twig' %}

{% block base_body_script %}
    {{ parent() }}

    {% if config('DotdigitalForShopware.config.wbtProfileId') %}
        {% set wbtPluginOptions = {
            regionId: config('DotdigitalForShopware.config.region'),
            profileId: config('DotdigitalForShopware.config.wbtProfileId')
        } %}
        {% if page.product %}
            {# Prices #}
            {% set unitPrice = page.product.calculatedCheapestPrice.unitPrice %}
            {% set listPrice = page.product.calculatedCheapestPrice.listPrice.price %}
            {% set hasDiscountedPrice = listPrice > unitPrice %}

            {% set productData = {
                productId: page.product.productNumber | default(''),
                sku: page.product.productNumber | default(''),
                name: page.product.translated.name ? page.product.translated.name : page.product.name | default(''),
                url: seoUrl('frontend.detail.page', { productId: page.product.id }) | default(''),
                imageUrl: page.product.cover.media.url | default(''),
                price: hasDiscountedPrice ? listPrice : unitPrice,
                currency: context.currency.isoCode | default(''),
                salePrice: hasDiscountedPrice ? unitPrice : 0,
                status: page.product.availableStock > 0 ? 'In stock' : 'Out of stock',
                stock: page.product.stock,
                description: page.product.translated.description ? page.product.translated.description : page.product.description | default(''),
                categories: page.product.seoCategory.name ? [page.product.seoCategory.name] : [],
                brand: page.product.manufacturer.name | default('')
            } %}
            {% set wbtPluginOptions = wbtPluginOptions|merge({ productData: productData }) %}
        {% endif %}

        <template data-wbt-plugin data-wbt-plugin-options='{{ wbtPluginOptions|json_encode }}'></template>
    {% endif %}

    {# Identify guests onBlur #}
    <template data-identify-plugin></template>

    {% sw_include '@DotdigitalForShopware/storefront/component/cart-insight.html.twig' %}
    {% sw_include '@DotdigitalForShopware/storefront/component/site-roi-tracking.html.twig' %}
{% endblock %}